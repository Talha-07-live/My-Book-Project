<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Firebase Admin — Search & Edit</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace }
    pre.json{ white-space: pre-wrap; word-break: break-word; background:#f3f4f6; padding:8px; border-radius:6px }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

    <!-- Header / Auth -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4 sm:gap-0">
      <h1 class="text-xl sm:text-2xl font-bold">Advanced Firebase Admin Panel</h1>
      <div id="authArea" class="flex items-center gap-3 w-full sm:w-auto">
        <div id="userInfo" class="hidden items-center gap-3">
          <span id="uidLabel" class="mono text-sm"></span>
          <button id="btnLogout" class="bg-gray-700 text-white px-3 py-1 rounded">Logout</button>
        </div>
        <div id="loginBox" class="bg-white p-3 rounded shadow w-full sm:w-96">
          <input id="email" class="border p-2 rounded w-full mb-2" placeholder="Admin email">
          <input id="password" type="password" class="border p-2 rounded w-full mb-2" placeholder="Password">
          <div class="flex flex-col sm:flex-row gap-2">
            <button id="btnLogin" class="bg-blue-600 text-white px-4 py-2 rounded flex-1 w-full sm:w-auto">Login</button>
            <button id="btnDemo" title="Quick demo" class="bg-gray-200 px-3 py-2 rounded w-full sm:w-auto">Demo</button>
          </div>
          <p id="loginErr" class="text-red-600 text-sm mt-2"></p>
        </div>
      </div>
    </div>

    <!-- Panel -->
    <div id="panel" class="hidden bg-white p-4 rounded shadow">

      <!-- Controls Grid -->
      <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-3 mb-3">

        <div>
          <label class="block text-sm font-semibold mb-1">Search Mode</label>
          <select id="mode" class="border p-2 rounded w-full">
            <option value="path">Path / exact key (movies/KEY or movies/KEY/sub)</option>
            <option value="prefix">Key prefix (startsWith)</option>
            <option value="field">Field search (title / subtitle / description / link)</option>
            <option value="full">Full-text (title|subtitle|desc|links)</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Search Query</label>
          <input id="q" class="border p-2 rounded w-full" placeholder="e.g. Jawan_2023 OR 720p OR john">
          <div class="text-xs text-gray-500 mt-1">Tip: use short keywords; for prefix mode type start of key</div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Options</label>
          <div class="flex flex-col gap-2">
            <label class="flex items-center gap-2"><input type="checkbox" id="searchAllNodes"> Search entire DB (not just /movies)</label>
            <div class="flex flex-col sm:flex-row gap-2 mt-2">
              <button id="btnSearch" class="bg-green-600 text-white px-4 py-2 rounded flex-1 w-full sm:w-auto">Search</button>
              <button id="btnClear" class="bg-gray-200 px-4 py-2 rounded flex-1 w-full sm:w-auto">Clear</button>
            </div>
          </div>
        </div>

      </div>

      <!-- Live suggestions -->
      <div class="mb-3">
        <div id="suggestions" class="flex gap-2 flex-wrap"></div>
      </div>

      <!-- Results summary -->
      <div class="mb-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0">
        <div class="text-sm text-gray-600" id="summary">No search yet</div>
        <div class="text-sm text-gray-600">Results per page:
          <select id="perPage" class="border p-1 rounded">
            <option>10</option><option>25</option><option>50</option>
          </select>
        </div>
      </div>

      <!-- Results Table -->
      <div id="resultsWrapper" class="overflow-x-auto bg-white rounded">
        <table class="min-w-full divide-y">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">#</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Path / Key</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Title / preview</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Actions</th>
            </tr>
          </thead>
          <tbody id="resultsTbody" class="bg-white divide-y"></tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="mt-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0">
        <div>
          <button id="prevPage" class="px-3 py-1 border rounded">Prev</button>
          <button id="nextPage" class="px-3 py-1 border rounded ml-0 sm:ml-2">Next</button>
        </div>
        <div id="pageInfo" class="text-sm text-gray-600"></div>
      </div>

      <!-- Editor Modal -->
      <div id="editorModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 p-4">
        <div class="bg-white rounded max-w-3xl w-full sm:w-11/12 p-4">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 gap-2 sm:gap-0">
            <h3 class="font-semibold">Edit Node: <span id="editPath" class="mono text-sm"></span></h3>
            <div class="flex gap-2">
              <button id="btnApply" class="bg-green-600 text-white px-4 py-1 rounded">Save</button>
              <button id="btnClose" class="bg-gray-200 px-3 py-1 rounded">Close</button>
            </div>
          </div>
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="text-sm font-semibold">Field Editor (form)</label>
              <div id="fieldForm" class="space-y-2 mt-2"></div>
            </div>
            <div>
              <label class="text-sm font-semibold">Raw JSON (editable)</label>
              <textarea id="rawJson" class="w-full border p-2 rounded h-64 mono"></textarea>
            </div>
          </div>
          <div class="mt-3 flex flex-col sm:flex-row gap-2">
            <button id="btnDelete" class="bg-red-600 text-white px-4 py-1 rounded">Delete Node</button>
            <div id="editorMsg" class="text-sm text-gray-600"></div>
          </div>
        </div>
      </div>

    </div>

    <!-- Footer -->
    <div class="text-xs text-gray-500 mt-4">
      Note: For very large datasets (>5000 items) client-side full-text can be slow — consider adding a server-side index (Algolia / Elastic / Firebase Functions indexed fields).
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDpiN0OV1aD709Q987PymfOOp_lcW6Hid8",
  authDomain: "my-book-project-c5a17.firebaseapp.com",
  databaseURL: "https://data.talhascollection.xo.je/movies_10000_oneline.json",
  projectId: "my-book-project-c5a17",
  storageBucket: "my-book-project-c5a17.appspot.com",
  messagingSenderId: "422603504433",
  appId: "1:422603504433:web:e6870a7d2c57c045eb0e10",
  measurementId: "G-F763MR7FR9"
};
const ADMIN_UID = "PDK5rMhfUAc2mFA7VwKh3EtItov1";
/* ================ INIT =================== */
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

/* ================ AUTH UI ================ */
const loginBox = document.getElementById('loginBox');
const userInfo = document.getElementById('userInfo');
const uidLabel = document.getElementById('uidLabel');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const loginErr = document.getElementById('loginErr');
const panel = document.getElementById('panel');

auth.onAuthStateChanged(user=>{
  if(user && user.uid === ADMIN_UID){
    loginBox.classList.add('hidden');
    userInfo.classList.remove('hidden');
    uidLabel.textContent = user.uid;
    panel.classList.remove('hidden');
    document.getElementById('loginErr').textContent = '';
  } else {
    loginBox.classList.remove('hidden');
    userInfo.classList.add('hidden');
    uidLabel.textContent = '';
    panel.classList.add('hidden');
  }
});

btnLogin.addEventListener('click', async ()=>{
  loginErr.textContent = '';
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  if(!email || !password){ loginErr.textContent = 'Enter credentials'; return; }
  try{ await auth.signInWithEmailAndPassword(email, password); }
  catch(err){ loginErr.textContent = err.message; }
});
btnLogout.addEventListener('click', ()=> auth.signOut());
document.getElementById('btnDemo').addEventListener('click', ()=> {
  document.getElementById('q').value = 'Jawan'; // demo
});

/* ============== SEARCH LOGIC ============== */
const qInput = document.getElementById('q');
const modeSelect = document.getElementById('mode');
const btnSearch = document.getElementById('btnSearch');
const btnClear = document.getElementById('btnClear');
const suggestionsDiv = document.getElementById('suggestions');
const resultsTbody = document.getElementById('resultsTbody');
const summary = document.getElementById('summary');
const perPageSel = document.getElementById('perPage');
const prevPage = document.getElementById('prevPage');
const nextPage = document.getElementById('nextPage');
const pageInfo = document.getElementById('pageInfo');

let allHits = []; // [{path, key, data}]
let page = 0;

function setSummary(){
  summary.textContent = `${allHits.length} result(s). Showing page ${page+1}`;
  pageInfo.textContent = `Page ${page+1} / ${Math.max(1, Math.ceil(allHits.length / parseInt(perPageSel.value || 10)))}`;
}

function renderResults(){
  resultsTbody.innerHTML = '';
  const perPage = parseInt(perPageSel.value || 10);
  const start = page * perPage;
  const end = start + perPage;
  const subset = allHits.slice(start, end);
  subset.forEach((hit,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-3 py-2 text-sm">${start + i + 1}</td>
      <td class="px-3 py-2 mono text-sm">${hit.path}</td>
      <td class="px-3 py-2 text-sm">${(hit.data && hit.data.title) ? '<strong>' + escapeHtml(hit.data.title) + '</strong><div class="text-xs text-gray-500">'+ escapeHtml((hit.data.subtitle||'') .toString().slice(0,80)) +'</div>' : '<pre class="json mono">'+ escapeHtml(JSON.stringify(hit.data)).slice(0,200) +'</pre>'}</td>
      <td class="px-3 py-2 text-sm">
        <button class="bg-blue-600 text-white px-2 py-1 rounded viewBtn">View</button>
        <button class="bg-yellow-500 text-white px-2 py-1 rounded editBtn">Edit</button>
        <button class="bg-red-600 text-white px-2 py-1 rounded delBtn">Delete</button>
      </td>
    `;
    // attach events
    tr.querySelector('.viewBtn').addEventListener('click', ()=> openEditor(hit.path, hit.data, false));
    tr.querySelector('.editBtn').addEventListener('click', ()=> openEditor(hit.path, hit.data, true));
    tr.querySelector('.delBtn').addEventListener('click', ()=> doDelete(hit.path));
    resultsTbody.appendChild(tr);
  });
  setSummary();
}

/* ---------- utility ---------- */
function escapeHtml(s){ return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function debounce(fn, ms=350){
  let t;
  return (...a)=>{ clearTimeout(t); t = setTimeout(()=> fn(...a), ms); };
}

/* ========== search helpers ========== */

// Fetch a node by exact path
async function fetchByPath(path){
  try{
    const snap = await db.ref(path).get();
    if(!snap.exists()) return null;
    return { path, key: path.split('/').pop(), data: snap.val() };
  }catch(e){ console.error(e); return null; }
}

// Fetch all under a base path (careful on very large)
async function fetchAllUnder(base='/movies'){
  const snap = await db.ref(base).get();
  if(!snap.exists()) return [];
  const val = snap.val();
  const out = [];
  // if object with keys
  for(const k of Object.keys(val)){
    out.push({ path: base.replace(/\/$/,'') + '/' + k, key: k, data: val[k] });
  }
  return out;
}

// client-side full-text filter (case-insensitive)
function filterHits(hits, q){
  if(!q) return hits;
  const qq = q.toLowerCase();
  return hits.filter(h=>{
    try{
      const d = h.data || {};
      if((h.key||'').toLowerCase().includes(qq)) return true;
      if((d.title||'').toLowerCase().includes(qq)) return true;
      if((d.subtitle||'').toLowerCase().includes(qq)) return true;
      if((d.description||'').toLowerCase().includes(qq)) return true;
      // links
      if(Array.isArray(d.downloadLinks)){
        for(const l of d.downloadLinks){
          if((l.text||'').toLowerCase().includes(qq)) return true;
          if((l.url||'').toLowerCase().includes(qq)) return true;
        }
      }
      // stringify fallback
      if(JSON.stringify(d).toLowerCase().includes(qq)) return true;
      return false;
    }catch(e){ return false; }
  });
}

/* ========== Main Search Flow ========== */

async function doSearch(){
  allHits = [];
  page = 0;
  resultsTbody.innerHTML = '';
  suggestionsDiv.innerHTML = '';
  summary.textContent = 'Searching...';

  const q = (qInput.value || '').trim();
  const mode = modeSelect.value;
  const searchAllNodes = document.getElementById('searchAllNodes').checked;

  try{
    if(mode === 'path'){
      // if path like movies/key or key
      const p = q.startsWith('/') ? q.slice(1) : q;
      const maybePaths = [];
      if(p.includes('/')) maybePaths.push(p);
      else {
        maybePaths.push('movies/' + p);
        maybePaths.push(p);
      }
      // try each
      for(const mp of maybePaths){
        const r = await fetchByPath(mp);
        if(r) allHits.push(r);
      }
    } else {
      // for prefix / field / full modes
      // determine base
      const base = searchAllNodes ? '/' : '/movies';
      // fetch all under base
      const hits = await fetchAllUnder(base);
      if(mode === 'prefix'){
        const qlow = q.toLowerCase();
        allHits = hits.filter(h => (h.key||'').toLowerCase().startsWith(qlow) || h.path.toLowerCase().includes(qlow));
      } else if(mode === 'field' || mode === 'full'){
        if(!q){ allHits = hits; }
        else allHits = filterHits(hits, q);
      }
    }

    // suggestions: top 6 keys
    suggestionsDiv.innerHTML = '';
    allHits.slice(0,6).forEach(h=>{
      const b = document.createElement('button');
      b.className = 'px-3 py-1 bg-gray-100 rounded text-sm';
      b.textContent = h.key + ' → ' + (h.data && h.data.title ? h.data.title : '');
      b.addEventListener('click', ()=> { qInput.value = h.key; modeSelect.value = 'path'; doSearch(); });
      suggestionsDiv.appendChild(b);
    });

    renderResults();
  }catch(e){
    console.error(e);
    summary.textContent = 'Error: ' + (e.message || e);
  }
}

/* ========== Editor ========== */
const editorModal = document.getElementById('editorModal');
const editPathLabel = document.getElementById('editPath');
const rawJson = document.getElementById('rawJson');
const fieldForm = document.getElementById('fieldForm');
const btnApply = document.getElementById('btnApply');
const btnClose = document.getElementById('btnClose');
const btnDelete = document.getElementById('btnDelete');
const editorMsg = document.getElementById('editorMsg');

let currentEdit = { path:null, data:null };

function openEditor(path, data, editable=true){
  currentEdit = { path, data: JSON.parse(JSON.stringify(data || {})) };
  editPathLabel.textContent = path;
  rawJson.value = JSON.stringify(currentEdit.data, null, 2);
  buildFieldForm(currentEdit.data);
  editorMsg.textContent = '';
  editorModal.style.display = 'flex';
  editorModal.classList.remove('hidden');
  btnApply.disabled = !editable;
  rawJson.disabled = !editable;
  btnDelete.disabled = !editable;
}

function closeEditor(){ editorModal.style.display = 'none'; editorModal.classList.add('hidden'); }

function buildFieldForm(obj){
  fieldForm.innerHTML = '';
  // show some common fields for movie objects to edit quickly
  const fields = ['title','poster','subtitle','description','rating','quality','releasedAt','trending','pinned'];
  fields.forEach(k=>{
    const val = obj[k] !== undefined ? obj[k] : '';
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `<label class="text-xs font-semibold">${k}</label>`;
    if(typeof val === 'boolean'){
      wrapper.innerHTML += `<div class="mt-1"><input type="checkbox" data-key="${k}" ${val ? 'checked' : ''}></div>`;
    } else {
      wrapper.innerHTML += `<input data-key="${k}" class="border p-1 rounded w-full mt-1" value="${escapeHtml(val)}">`;
    }
    fieldForm.appendChild(wrapper);
  });

  // downloadLinks editor (simple)
  const dl = obj.downloadLinks || [];
  const dlWrap = document.createElement('div');
  dlWrap.innerHTML = '<label class="text-xs font-semibold mt-2">downloadLinks (text / url)</label>';
  const dlList = document.createElement('div');
  dlList.className = 'space-y-1 mt-1';
  dl.forEach((it, idx)=>{
    const row = document.createElement('div');
    row.className = 'flex gap-2';
    row.innerHTML = `<input data-key="dl_text_${idx}" class="border p-1 rounded flex-1" value="${escapeHtml(it.text||'')}">
                     <input data-key="dl_url_${idx}" class="border p-1 rounded flex-1" value="${escapeHtml(it.url||'')}">`;
    dlList.appendChild(row);
  });
  // add button to add new link
  const addBtn = document.createElement('button');
  addBtn.className = 'bg-gray-200 px-2 py-1 rounded text-sm mt-2';
  addBtn.textContent = 'Add Link';
  addBtn.addEventListener('click', ()=>{
    const idx = (fieldForm.querySelectorAll('[data-key^="dl_text_"]').length);
    const row = document.createElement('div');
    row.className = 'flex gap-2';
    row.innerHTML = `<input data-key="dl_text_${idx}" class="border p-1 rounded flex-1" value="">
                     <input data-key="dl_url_${idx}" class="border p-1 rounded flex-1" value="">`;
    dlList.appendChild(row);
  });

  dlWrap.appendChild(dlList);
  dlWrap.appendChild(addBtn);
  fieldForm.appendChild(dlWrap);
}

/* apply changes from fieldForm into rawJson and save */
btnApply.addEventListener('click', async ()=>{
  try{
    // merge field form into object
    const obj = JSON.parse(rawJson.value);
    // fields
    fieldForm.querySelectorAll('[data-key]').forEach(el=>{
      const key = el.getAttribute('data-key');
      if(key.startsWith('dl_text_') || key.startsWith('dl_url_')) return; // handle later
      if(el.type === 'checkbox') obj[key] = el.checked;
      else obj[key] = el.value;
    });
    // download links rebuild
    const dlTextEls = Array.from(fieldForm.querySelectorAll('[data-key^="dl_text_"]'));
    const dl = [];
    for(const tEl of dlTextEls){
      const idx = tEl.getAttribute('data-key').split('_').pop();
      const urlEl = fieldForm.querySelector(`[data-key="dl_url_${idx}"]`);
      const text = (tEl.value || '').trim();
      const url = (urlEl && urlEl.value) ? urlEl.value.trim() : '';
      if(url) dl.push({ text, url });
    }
    if(dl.length) obj.downloadLinks = dl;

    // try parse JSON to ensure valid
    const jsonStr = JSON.stringify(obj, null, 2);
    rawJson.value = jsonStr;

    // write to firebase
    await db.ref(currentEdit.path).set(obj);
    editorMsg.textContent = 'Saved ✓';
    // update local hits if present
    const hitIdx = allHits.findIndex(h => h.path === currentEdit.path);
    if(hitIdx !== -1) allHits[hitIdx].data = obj;
    renderResults();
  }catch(e){
    editorMsg.textContent = 'Error: ' + (e.message || e);
  }
});

btnClose.addEventListener('click', closeEditor);

async function doDelete(path){
  if(!confirm('Delete node at ' + path + ' ?')) return;
  try{
    await db.ref(path).remove();
    // remove from allHits
    allHits = allHits.filter(h => h.path !== path);
    renderResults();
  }catch(e){
    alert('Delete error: ' + (e.message || e));
  }
}

btnDelete.addEventListener('click', async ()=>{
  if(!confirm('Delete current node?')) return;
  try{
    await db.ref(currentEdit.path).remove();
    editorMsg.textContent = 'Deleted ✓';
    // remove local
    allHits = allHits.filter(h => h.path !== currentEdit.path);
    renderResults();
    closeEditor();
  }catch(e){
    editorMsg.textContent = 'Delete error: ' + (e.message || e);
  }
});

/* pagination */
prevPage.addEventListener('click', ()=> {
  if(page > 0){ page--; renderResults(); }
});
nextPage.addEventListener('click', ()=> {
  const perPage = parseInt(perPageSel.value || 10);
  if((page+1) * perPage < allHits.length){ page++; renderResults(); }
});

/* bind search */
btnSearch.addEventListener('click', doSearch);
btnClear.addEventListener('click', ()=>{
  qInput.value = ''; modeSelect.value = 'field'; resultsTbody.innerHTML = ''; allHits = []; summary.textContent = 'Cleared';
});

/* live suggestions while typing (debounced) */
qInput.addEventListener('input', debounce(async ()=>{
  const q = qInput.value.trim();
  if(!q) { suggestionsDiv.innerHTML = ''; return; }
  // lightweight search: fetch first 200 under /movies and filter client-side
  try{
    const hits = await fetchAllUnder('/movies');
    const filtered = hits.filter(h => (h.key||'').toLowerCase().includes(q.toLowerCase()) || JSON.stringify(h.data).toLowerCase().includes(q.toLowerCase()));
    suggestionsDiv.innerHTML = '';
    filtered.slice(0,6).forEach(h=>{
      const b = document.createElement('button');
      b.className = 'px-3 py-1 bg-gray-100 rounded text-sm';
      b.textContent = h.key + ' → ' + (h.data && h.data.title ? h.data.title : '');
      b.addEventListener('click', ()=> { qInput.value = h.key; modeSelect.value = 'path'; doSearch(); });
      suggestionsDiv.appendChild(b);
    });
  }catch(e){ /* ignore */ }
}, 300));

/* keyboard: enter triggers search */
qInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter'){ e.preventDefault(); doSearch(); } });

</script>
</body>
</html>
